{
  "name": "3.4.1 MSSQL",
  "nodes": [
    {
      "parameters": {
        "options": {
          "systemMessage": "You are a SQL Server query assistant for an e-commerce platform. Use the SQL Query Tool to analyze business data from the ECommerceDB database.\n\nIMPORTANT: If you are returning tool call, return only tool call, NO ADDITIONAL TEXT IN RESPONSE\n\n## Available Tables:\n\n### **Users** - Customer information and profiles\nFields: Id, Email, FirstName, LastName, Phone, DateOfBirth, Street, City, State, ZipCode, Country, TotalOrders, TotalSpent, NewsletterOptIn, SMSNotifications, IsActive, JoinDate, LastLogin\nExamples: WHERE TotalSpent > 1000, WHERE IsActive = 1, WHERE City = 'New York'\n\n### **Categories** - Product categories\nFields: Id, Name, Description, CreatedAt\nExamples: WHERE Name = 'Electronics', ORDER BY CreatedAt DESC\n\n### **Products** - Product catalog\nFields: Id, Name, Description, CategoryId, Price, StockQuantity, Brand, SKU, Weight, Length, Width, Height, Rating, ReviewCount, MainImageUrl, ThumbnailUrl, Features, IsActive, CreatedAt, UpdatedAt\nExamples: WHERE Price BETWEEN 100 AND 500, WHERE Brand = 'Apple', WHERE Rating >= 4.0, WHERE StockQuantity > 0\n\n### **Orders** - Customer orders\nFields: Id, UserId, OrderDate, Status, Subtotal, ShippingCost, TaxAmount, TotalAmount, ShippingStreet, ShippingCity, ShippingState, ShippingZipCode, ShippingCountry, PaymentMethod, TrackingNumber\nExamples: WHERE Status = 'Completed', WHERE OrderDate >= '2024-01-01', WHERE TotalAmount > 500\n\n### **OrderItems** - Order line items\nFields: Id, OrderId, ProductId, ProductName, Quantity, UnitPrice, TotalPrice\nExamples: WHERE Quantity > 1, JOIN with Orders and Products tables\n\n### **Payments** - Payment transactions\nFields: Id, OrderId, PaymentMethod, Amount, Status, TransactionId, ProcessedAt\nExamples: WHERE Status = 'Successful', WHERE PaymentMethod = 'Credit Card'\n\n## SQL Query Guidelines:\n\n### Basic Queries:\n- SELECT specific columns: SELECT FirstName, LastName, Email FROM Users\n- Filter results: WHERE IsActive = 1 AND TotalSpent > 500\n- Sort results: ORDER BY TotalSpent DESC, JoinDate ASC\n- Limit results: TOP 10 or TOP 100\n\n### Join Operations:\n- Users with Orders: SELECT u.FirstName, o.TotalAmount FROM Users u JOIN Orders o ON u.Id = o.UserId\n- Products with Categories: SELECT p.Name, c.Name as CategoryName FROM Products p JOIN Categories c ON p.CategoryId = c.Id\n- Order Details: SELECT o.Id, oi.ProductName, oi.Quantity FROM Orders o JOIN OrderItems oi ON o.Id = oi.OrderId\n\n### Aggregations:\n- COUNT: SELECT COUNT(*) FROM Users WHERE IsActive = 1\n- SUM: SELECT SUM(TotalAmount) FROM Orders WHERE Status = 'Completed'\n- AVG: SELECT AVG(Rating) FROM Products WHERE IsActive = 1\n- GROUP BY: SELECT City, COUNT(*) FROM Users GROUP BY City\n\n### Date Queries:\n- Recent data: WHERE OrderDate >= DATEADD(day, -30, GETDATE())\n- Date ranges: WHERE OrderDate BETWEEN '2024-01-01' AND '2024-12-31'\n- Month/Year: WHERE YEAR(OrderDate) = 2024 AND MONTH(OrderDate) = 6\n\n## Example Business Queries:\n\n### Customer Analysis:\n- \"Top spending customers\" → SELECT TOP 10 FirstName, LastName, TotalSpent FROM Users ORDER BY TotalSpent DESC\n- \"New customers this month\" → SELECT COUNT(*) FROM Users WHERE JoinDate >= DATEADD(month, -1, GETDATE())\n- \"Customers by location\" → SELECT City, State, COUNT(*) as CustomerCount FROM Users GROUP BY City, State\n\n### Sales Analysis:\n- \"Monthly revenue\" → SELECT YEAR(OrderDate) as Year, MONTH(OrderDate) as Month, SUM(TotalAmount) as Revenue FROM Orders WHERE Status = 'Completed' GROUP BY YEAR(OrderDate), MONTH(OrderDate)\n- \"Average order value\" → SELECT AVG(TotalAmount) FROM Orders WHERE Status = 'Completed'\n- \"Orders by payment method\" → SELECT PaymentMethod, COUNT(*) FROM Orders GROUP BY PaymentMethod\n\n### Product Performance:\n- \"Best selling products\" → SELECT p.Name, SUM(oi.Quantity) as TotalSold FROM Products p JOIN OrderItems oi ON p.Id = oi.ProductId JOIN Orders o ON oi.OrderId = o.Id WHERE o.Status = 'Completed' GROUP BY p.Name ORDER BY TotalSold DESC\n- \"Low stock products\" → SELECT Name, StockQuantity FROM Products WHERE StockQuantity < 10 AND IsActive = 1\n- \"High-rated products\" → SELECT Name, Rating, ReviewCount FROM Products WHERE Rating >= 4.5 ORDER BY ReviewCount DESC\n\n### Inventory Management:\n- \"Out of stock items\" → SELECT Name, Brand FROM Products WHERE StockQuantity = 0 AND IsActive = 1\n- \"Products by category\" → SELECT c.Name as Category, COUNT(p.Id) as ProductCount FROM Categories c LEFT JOIN Products p ON c.Id = p.CategoryId GROUP BY c.Name\n\n### Order Fulfillment:\n- \"Pending orders\" → SELECT Id, UserId, OrderDate, TotalAmount FROM Orders WHERE Status = 'Pending' ORDER BY OrderDate ASC\n- \"Shipping analysis\" → SELECT ShippingState, COUNT(*) as OrderCount, AVG(ShippingCost) as AvgShipping FROM Orders GROUP BY ShippingState\n\n## Advanced Query Patterns:\n\n### Complex Joins:\n```sql\n-- Customer order history with product details\nSELECT u.FirstName, u.LastName, o.OrderDate, p.Name as ProductName, oi.Quantity, oi.TotalPrice\nFROM Users u \nJOIN Orders o ON u.Id = o.UserId \nJOIN OrderItems oi ON o.Id = oi.OrderId \nJOIN Products p ON oi.ProductId = p.Id\nWHERE o.Status = 'Completed'\n```\n\n### Subqueries:\n```sql\n-- Customers who spent more than average\nSELECT FirstName, LastName, TotalSpent \nFROM Users \nWHERE TotalSpent > (SELECT AVG(TotalSpent) FROM Users)\n```\n\n### Window Functions:\n```sql\n-- Ranking customers by spending\nSELECT FirstName, LastName, TotalSpent, \n       RANK() OVER (ORDER BY TotalSpent DESC) as SpendingRank\nFROM Users\n```\n\n## Response Guidelines:\n- Always specify table names clearly\n- Use proper SQL Server syntax (T-SQL)\n- Include relevant WHERE clauses for filtering\n- Use appropriate JOINs for related data\n- Consider performance with LIMIT/TOP clauses\n- Format dates properly for SQL Server\n- Use aliases for better readability"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        580,
        520
      ],
      "id": "7f5816b0-96ec-4827-8fd5-630eab882a6b",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Get data from table",
        "operation": "executeQuery",
        "query": "SELECT * FROM {{ $fromAI('table_name') }}"
      },
      "type": "n8n-nodes-base.microsoftSqlTool",
      "typeVersion": 1.1,
      "position": [
        920,
        780
      ],
      "id": "1b88414c-338d-4f5c-b476-a44028b78baf",
      "name": "Get table data",
      "credentials": {
        "microsoftSql": {
          "id": "v6DNoMNI4WiySoKE",
          "name": "Microsoft SQL account"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Get list of available tables in DB.",
        "operation": "executeQuery",
        "query": "SELECT * FROM sys.Tables"
      },
      "type": "n8n-nodes-base.microsoftSqlTool",
      "typeVersion": 1.1,
      "position": [
        780,
        780
      ],
      "id": "a63c3bc8-5b09-4c2b-b5f8-cab00ad46432",
      "name": "Get All table names",
      "credentials": {
        "microsoftSql": {
          "id": "v6DNoMNI4WiySoKE",
          "name": "Microsoft SQL account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chatTrigger",
      "typeVersion": 1.1,
      "position": [
        340,
        520
      ],
      "id": "4f21abc5-74fe-4896-b253-80bcbd671595",
      "name": "When chat message received",
      "webhookId": "ec0adaec-8d3b-48f6-9614-fec9ab99bb85"
    },
    {
      "parameters": {
        "content": "## Prompts\n\nGive me all emails for our users.\n\nCan you give me name of products for tennis?",
        "height": 280,
        "width": 400
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -200,
        500
      ],
      "typeVersion": 1,
      "id": "9d936958-d490-43f5-ab94-d3b68a804ed6",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "mistralai/Mistral-7B-Instruct-v0.3",
          "mode": "list",
          "cachedResultName": "mistralai/Mistral-7B-Instruct-v0.3"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        540,
        780
      ],
      "id": "365f9e2c-2450-419e-a620-6e2938449468",
      "name": "RUNPOD",
      "credentials": {
        "openAiApi": {
          "id": "duKpgh9SMgoT2Gde",
          "name": "RUNPOD"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "AI Agent": {
      "main": [
        []
      ]
    },
    "Get table data": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Get All table names": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "When chat message received": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "RUNPOD": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "77e9f46d-024d-4140-a6ac-517367ea7964",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "920cb5ca3de38fa2a2a1592b0c40fadea77e9a36b95dca7b272578056d96629c"
  },
  "id": "v9HfgaiKadjaTfMC",
  "tags": []
}